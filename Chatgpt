import os
import csv
import numpy as np

network_location = '//NASWDC/Data/Betfair/Soccer/Test'
output_file = 'output.csv'
variance_threshold = 0.05

def calculate_averages(values):
    if len(values) == 0:
        return None
    return sum(values) / len(values)

def process_file(file_path):
    print(f"Processing file: {file_path}")
    event_data = {
        'CS_File': None,
        'eventId': None,
        'EventName': None,
        'SelectionId': None,
        'Back_P0': [],
        'Lay_P0': []
    }

    with open(file_path, 'r') as file:
        csv_reader = csv.DictReader(file)
        for i, row in enumerate(csv_reader):
            if row['SelectionId'] == '1096':
                if row['Inplay'] == 'True':
                    event_data['Back_P0'].append(float(row['back_P0']))
                    event_data['Lay_P0'].append(float(row['lay_P0']))

            if i >= 10:
                break

    return event_data

def write_output(output_data):
    try:
        with open(output_file, 'w', newline='') as output:
            fieldnames = ['CS_File', 'eventId', 'EventName', 'SelectionId', 'Back_P0_Average', 'Lay_P0_Average']
            writer = csv.DictWriter(output, fieldnames=fieldnames)
            writer.writeheader()
            for data in output_data:
                avg_back_P0 = calculate_averages(data['Back_P0'])
                avg_lay_P0 = calculate_averages(data['Lay_P0'])
                writer.writerow({
                    'CS_File': data['CS_File'],
                    'eventId': data['eventId'],
                    'EventName': data['EventName'],
                    'SelectionId': '1096',
                    'Back_P0_Average': avg_back_P0,
                    'Lay_P0_Average': avg_lay_P0,
                })
    except Exception as e:
        print(f"Error writing to output file: {e}")

def main():
    output_data = []

    for file_name in os.listdir(network_location):
        if file_name.startswith('CS') and file_name.endswith('.txt'):
            file_path = os.path.join(network_location, file_name)
            event_data = process_file(file_path)

            if len(event_data['Back_P0']) >= 10 and len(event_data['Lay_P0']) >= 10:
                while np.var(event_data['Back_P0']) >= variance_threshold or np.var(event_data['Lay_P0']) >= variance_threshold:
                    event_data['Back_P0'].pop(0)
                    event_data['Lay_P0'].pop(0)

                event_data['CS_File'] = file_name
                output_data.append(event_data)

    # Print the output data before writing to the file
    print(output_data)

    # Example: Adding dummy data to output_data
    output_data.append({
        'CS_File': 'dummy_file.txt',
        'eventId': 'dummy_event_id',
        'EventName': 'Dummy Event',
        'SelectionId': '1096',
        'Back_P0': [1.0, 2.0, 3.0, 4.0, 5.0],
        'Lay_P0': [2.0, 3.0, 4.0, 5.0, 6.0]
    })

    try:
        write_output(output_data)
    except Exception as e:
        print(f"Error writing output file: {e}")

    if __name__ == "__main__":
        main()
